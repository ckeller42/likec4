name: nightly

on:
  workflow_dispatch:
    inputs:
      note:
        description: 'Manual nightly build (artifact only)'
        required: false
        default: ''

permissions:
  contents: write

env:
  NODE_ENV: production
  FORCE_COLOR: true
  DO_NOT_TRACK: '1'

jobs:
  build-and-pack:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ›Žï¸ Checkout
        uses: actions/checkout@v4

      - name: ðŸ› ï¸ Setup pnpm
        uses: pnpm/action-setup@v4

      - name: ðŸ› ï¸ Setup node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: ðŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          HUSKY: '0'

      - name: ðŸ—ï¸ Build workspace (deps for CLI)
        run: pnpm turbo run build --filter="!@likec4/docs-astro" --filter="!@likec4/playground"

      - name: ðŸ—ï¸ Build CLI and pack
        run: |
          cd packages/likec4
          NODE_ENV=production pnpm run build-cli
          pnpm exec likec4ops prepack
          pnpm pack

      - name: â¬†ï¸ Upload CLI tarball
        uses: actions/upload-artifact@v4
        with:
          name: likec4-nightly-${{ github.sha }}
          path: packages/likec4/likec4-*.tgz

      # Publish a Release asset in this fork (no npm publish).
      - name: ðŸ“Œ Prepare release metadata
        if: github.repository_owner == 'ckeller42'
        run: |
          echo "TAG=nightly-${GITHUB_SHA}" >> "$GITHUB_ENV"
          ASSET_PATH=$(ls packages/likec4/likec4-*.tgz)
          echo "ASSET_PATH=${ASSET_PATH}" >> "$GITHUB_ENV"
          echo "ASSET_NAME=$(basename "${ASSET_PATH}")" >> "$GITHUB_ENV"

      - name: ðŸ§¾ Create release
        if: github.repository_owner == 'ckeller42'
        id: create_release
        uses: actions/create-release@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: ${{ env.TAG }}
          release_name: Nightly ${{ env.TAG }}
          draft: false
          prerelease: true
          body: "Nightly build for commit ${{ github.sha }} (artifact-only)."

      - name: ðŸ“¤ Upload release asset
        if: github.repository_owner == 'ckeller42'
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ env.ASSET_PATH }}
          asset_name: ${{ env.ASSET_NAME }}
          asset_content_type: application/gzip

      # Publishing to npm is intentionally disabled for safety.
      # To enable in this fork, add an NPM_TOKEN secret and remove the "if: false" guard.
      # - name: ðŸš« Publish (disabled)
      #   if: false
      #   env:
      #     NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      #   run: |
      #     cd packages/likec4
      #     npm version prerelease --preid=nightly --no-git-tag-version
      #     npm publish --tag next
