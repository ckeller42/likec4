name: nightly

on:
  workflow_dispatch:
    inputs:
      note:
        description: 'Manual nightly build (artifact only)'
        required: false
        default: ''

permissions:
  contents: read

env:
  NODE_ENV: production
  FORCE_COLOR: true
  DO_NOT_TRACK: '1'

jobs:
  build-and-pack:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸ Checkout
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Setup pnpm
        uses: pnpm/action-setup@v4

      - name: ğŸ› ï¸ Setup node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          HUSKY: '0'

      - name: ğŸ—ï¸ Build workspace (deps for CLI)
        run: pnpm turbo run build --filter="!@likec4/docs-astro" --filter="!@likec4/playground"

      - name: ğŸ—ï¸ Build CLI and pack
        run: |
          cd packages/likec4
          NODE_ENV=production pnpm run build-cli
          pnpm exec likec4ops prepack
          pnpm pack

      - name: â¬†ï¸ Upload CLI tarball
        uses: actions/upload-artifact@v4
        with:
          name: likec4-nightly-${{ github.sha }}
          path: packages/likec4/likec4-*.tgz

      # Publishing to npm is intentionally disabled for safety.
      # To enable in this fork, add an NPM_TOKEN secret and remove the "if: false" guard.
      # - name: ğŸš« Publish (disabled)
      #   if: false
      #   env:
      #     NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      #   run: |
      #     cd packages/likec4
      #     npm version prerelease --preid=nightly --no-git-tag-version
      #     npm publish --tag next
